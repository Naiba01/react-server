<!DOCTYPE html>

<html>
<head>
  <title>Navigator.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="Cache.html">
                  Cache.js
                </a>
              
                
                <a class="source" href="Plugins.html">
                  Plugins.js
                </a>
              
                
                <a class="source" href="Request.html">
                  Request.js
                </a>
              
                
                <a class="source" href="util.html">
                  util.js
                </a>
              
                
                <a class="source" href="History.html">
                  History.js
                </a>
              
                
                <a class="source" href="RootContainer.html">
                  RootContainer.js
                </a>
              
                
                <a class="source" href="RootElement.html">
                  RootElement.js
                </a>
              
                
                <a class="source" href="TheFold.html">
                  TheFold.js
                </a>
              
                
                <a class="source" href="Navigator.html">
                  Navigator.js
                </a>
              
                
                <a class="source" href="RequestContext.html">
                  RequestContext.js
                </a>
              
                
                <a class="source" href="client.html">
                  client.js
                </a>
              
                
                <a class="source" href="common.html">
                  common.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="stats.html">
                  stats.js
                </a>
              
                
                <a class="source" href="ClientCssHelper.html">
                  ClientCssHelper.js
                </a>
              
                
                <a class="source" href="LABString.html">
                  LABString.js
                </a>
              
                
                <a class="source" href="PageUtil.html">
                  PageUtil.js
                </a>
              
                
                <a class="source" href="RequestLocalStorage.html">
                  RequestLocalStorage.js
                </a>
              
                
                <a class="source" href="StringEscapeUtil.html">
                  StringEscapeUtil.js
                </a>
              
                
                <a class="source" href="bundleNameUtil.html">
                  bundleNameUtil.js
                </a>
              
                
                <a class="source" href="navigateTo.html">
                  navigateTo.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Navigator.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter,
	logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../logging'</span>).getLogger(__LOGGER__),
	Router = <span class="hljs-built_in">require</span>(<span class="hljs-string">'routr'</span>),
	Q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>),
	History = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../components/History"</span>),
	ReactServerAgent = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../ReactServerAgent"</span>),
	PageUtil = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../util/PageUtil"</span>);

<span class="hljs-keyword">var</span> _ = {
	isFunction: <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/isFunction'</span>),
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Navigator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>{

	<span class="hljs-keyword">constructor</span> (context, routes) {
		<span class="hljs-keyword">super</span>();

		<span class="hljs-keyword">this</span>.router = <span class="hljs-keyword">new</span> Router(routes.routes);
		<span class="hljs-keyword">this</span>.context = context;

		<span class="hljs-keyword">this</span>._globalMiddleware = routes.middleware;
		<span class="hljs-keyword">this</span>._loading = <span class="hljs-literal">false</span>;
		<span class="hljs-keyword">this</span>._currentRoute = <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">this</span>._nextRoute = <span class="hljs-literal">null</span>;
	}

	<span class="hljs-comment">/**
	 * type is one of
	 *    History.events.PUSHSTATE: user clicked something to go forward but browser didn't do a
	 * full page load
	 *    History.events.POPSTATE: user clicked back button but browser didn't do a full page load
	 *    History.events.PAGELOAD: full browser page load, not using History API.
	 *
	 * Default is History.events.PAGELOAD.
	 */</span>
	navigate (request, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>If we’re in a frameback frame we might need to make a
round-trip through the outer frame for navigaton to make
sure the history navigation stack of the primary window is
maintained properly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.context.framebackControllerWillHandle(request, type)) {
			<span class="hljs-keyword">return</span>;
		}

		logger.debug(<span class="hljs-string">`Navigating to <span class="hljs-subst">${request.getUrl()}</span>`</span>);
		type = type || History.events.PAGELOAD;

		<span class="hljs-keyword">this</span>._haveInitialized = <span class="hljs-literal">true</span>;

		<span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.router.getRoute(request.getUrl(), {navigate: {path:request.getUrl(), type:type}});

		<span class="hljs-keyword">if</span> (route) {
			logger.debug(<span class="hljs-string">`Mapped <span class="hljs-subst">${request.getUrl()}</span> to route <span class="hljs-subst">${route.name}</span>`</span>);
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!request._frameback) {
			<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'navigateDone'</span>, { status: <span class="hljs-number">404</span>, message: <span class="hljs-string">"No Route!"</span> }, <span class="hljs-literal">null</span>, request.getUrl(), type);
			<span class="hljs-keyword">return</span>;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We may or may not <em>actually</em> start this route client side.</p>
<p>If there’s a flurry of navigation we skip any routes that
blow by while we’re still working on a page, and only
finally start the <em>last</em> one.</p>
<p>The promise returned from <code>startRoute()</code> will be rejected
if we’re not going to proceed, so resources will be freed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>
		.startRoute(route, request, type)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>We might have a data bundle on hand, or the request may
have asked us to fetch it one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		.then(<span class="hljs-keyword">this</span>._dealWithDataBundleLoading.bind(<span class="hljs-keyword">this</span>, request))

		.then(() =&gt; {
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ignoreCurrentNavigation){</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This is a one-time deal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>._ignoreCurrentNavigation = <span class="hljs-literal">false</span>;
				<span class="hljs-keyword">return</span>;
			}

			<span class="hljs-comment">/* Breathe... */</span>

			<span class="hljs-keyword">var</span> loaders = route.config.page;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Normalize.
The page object may either directly be a loader or
it may be an object whose values are loaders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (_.isFunction(loaders)){
				loaders = {<span class="hljs-string">'default'</span>: loaders};
			}

			<span class="hljs-keyword">var</span> mobileDetect = <span class="hljs-keyword">this</span>.context.getMobileDetect();</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Our route may have multiple page implementations if
there are device-specific variations.</p>
<p>We’ll take one of those if the request device
matches, otherwise we’ll use the default.</p>
<p>Note that ‘mobile’ is the <em>union</em> of ‘phone’ and
‘tablet’.  If you <em>really</em> want an iPad and an
iPhone to get the <em>same</em> non-desktop experience,
use that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> loadPage = [
				<span class="hljs-string">'phone'</span>,
				<span class="hljs-string">'tablet'</span>,
				<span class="hljs-string">'mobile'</span>,
			].reduce((loader, format) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>We’ll take the <em>first</em> format that matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (!loader &amp;&amp; loaders[format] &amp;&amp; mobileDetect[format]()){</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Need to disambiguate for bundleNameUtil.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					route.name += <span class="hljs-string">'-'</span>+format;

					<span class="hljs-keyword">return</span> loaders[format];
				}

				<span class="hljs-keyword">return</span> loader;
			}, <span class="hljs-literal">null</span>) || loaders.default;

			loadPage().done(pageConstructor =&gt; {
				<span class="hljs-keyword">if</span> (request.setRoute) {
					request.setRoute(route);
				}
				<span class="hljs-keyword">this</span>.handlePage(pageConstructor, request, type);

			}, err =&gt; {
				<span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error resolving page"</span>, err);
			});

		});

	}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If you call this you’re responsible for calling <code>finishRoute()</code>
when you’re done with whatever it is you’re hiding from the
navigator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	ignoreCurrentNavigation() {
		<span class="hljs-keyword">this</span>._ignoreCurrentNavigation = <span class="hljs-literal">true</span>;
	}

	_dealWithDataBundleLoading(request) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If we’re managing a frame’s navigation, we want <em>it</em> to
use a data bundle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._ignoreCurrentNavigation) <span class="hljs-keyword">return</span> Q();</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>If this request doesn’t use a data bundle, we’re done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!request.getBundleData()) <span class="hljs-keyword">return</span> Q();</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>If the request wants all of the data fetched as a bundle
we’ll need to kick off the request for the bundle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> ReactServerAgent._fetchDataBundle(request.getUrl())
			.then(ReactServerAgent._rehydrateDataBundle)
			.catch(err =&gt; logger.error(<span class="hljs-string">'Data bundle error'</span>, err));
	}

	handlePage(pageConstructor, request, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>instantiate the pages we need to fulfill this request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> pageClasses = [];

		<span class="hljs-keyword">this</span>._addPageMiddlewareToArray(<span class="hljs-keyword">this</span>._globalMiddleware, pageClasses);
		<span class="hljs-keyword">this</span>._addPageMiddlewareToArray([pageConstructor], pageClasses);

		<span class="hljs-keyword">var</span> pages = pageClasses.map((pageClass) =&gt; {
			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.getOwnPropertyNames(pageClass).length === <span class="hljs-number">0</span>) {
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Tried to instantiate a page or middleware class that was an empty object. Did you forget to assign a class to module.exports?"</span>);
			}
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> pageClass();
		});
		<span class="hljs-keyword">var</span> page = PageUtil.createPageChain(pages);

		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"page"</span>, page);

		page.setRequest(request);

		PageUtil.PageConfig.initFromPageWithDefaults(page, {
			isFragment    : <span class="hljs-literal">false</span>,
			isRawResponse : <span class="hljs-literal">false</span>,
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>call page.handleRoute(), and use the resulting code to decide how to
respond.
We call it in a promise handler so any exception that
arises will get converted to a rejection that we can handle
below.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		Q().then(page.handleRoute).then(handleRouteResult =&gt; {

			page.setStatus(handleRouteResult.code);

			page.setHasDocument(handleRouteResult.hasDocument);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO: I think that 3xx/4xx/5xx shouldn’t be considered “errors” in navigateDone, but that’s
how the code is structured right now, and I’m changing too many things at once at the moment. -sra.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (handleRouteResult.code &amp;&amp; ((handleRouteResult.code / <span class="hljs-number">100</span>)|<span class="hljs-number">0</span>) !== <span class="hljs-number">2</span>) {
				<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"navigateDone"</span>, {status: handleRouteResult.code, redirectUrl: handleRouteResult.location}, page, request.getUrl(), type);
				<span class="hljs-keyword">return</span>;
			}
			<span class="hljs-keyword">if</span> (handleRouteResult.page) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>in this case, we should forward to a new page <em>without</em> changing the URL. Since we are already
in an async callback, we should schedule a new handlePage with the new page constructor and return
from this call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				setTimeout(() =&gt; <span class="hljs-keyword">this</span>.handlePage(handleRouteResult.page, request, type), <span class="hljs-number">0</span>);
				<span class="hljs-keyword">return</span>;
			}

			<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'navigateDone'</span>, <span class="hljs-literal">null</span>, page, request.getUrl(), type);
		}).catch(err =&gt; {
			logger.error(<span class="hljs-string">"Error while handling route"</span>, err);

			<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'navigateDone'</span>, {status: <span class="hljs-number">500</span>}, page, request.getUrl(), type);
		});

	}

	<span class="hljs-comment">/**
	 * recursively adds the middleware in the pages array to array.
	 */</span>
	_addPageMiddlewareToArray(pages, array) {
		<span class="hljs-keyword">if</span> (!pages) <span class="hljs-keyword">return</span>;
		pages.forEach((page) =&gt; {
			<span class="hljs-keyword">if</span> (page.middleware) {
				<span class="hljs-keyword">this</span>._addPageMiddlewareToArray(page.middleware(), array);
			}
			array.push(page);
		});
	}

	getState () {
		<span class="hljs-keyword">return</span> {
			loading: <span class="hljs-keyword">this</span>._loading,
			route: <span class="hljs-keyword">this</span>._currentRoute,
		}
	}

	getCurrentRoute () {
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._currentRoute;
	}

	getLoading () {
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._loading;
	}

	startRoute (route, request, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>If we’re being called with a requested route, we’ll need to
tell the caller when they can proceed with their
navigation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> dfd, promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>We need to handle the case where routes are requested while
we’re handling the previous navigation.  This can happen if
the user furiously clicks the browser’s forward/back
navigation buttons.</p>
<p>We don’t want a <em>queue</em> here, because we’re only ultimately
going to show the user the <em>final</em> route that’s requested,
so we’ll just keep a single reference to the next route we
need to actually render once our current navigation is
complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (request) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>We don’t want to leave navigation detritus
laying around as we discard bypassed pages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._nextRoute) <span class="hljs-keyword">this</span>._nextRoute.dfd.reject();

			dfd = Q.defer(), promise = dfd.promise;

			<span class="hljs-keyword">this</span>._nextRoute = {route, request, type, dfd};
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If we’re <em>currently</em> navigating, we’ll wait to start the
next route until this navigation is complete.  Interleaved
navigation causes all kinds of havoc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._loading &amp;&amp; <span class="hljs-keyword">this</span>._nextRoute){

			<span class="hljs-keyword">const</span> {route, request, type, dfd} = <span class="hljs-keyword">this</span>._nextRoute;

			<span class="hljs-keyword">this</span>._loading      = <span class="hljs-literal">true</span>;
			<span class="hljs-keyword">this</span>._currentRoute = route;
			<span class="hljs-keyword">this</span>._nextRoute    = <span class="hljs-literal">null</span>;

			<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'navigateStart'</span>, {route, request, type});</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>This allows the actual navigation to
proceed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			dfd.resolve();
		}

		<span class="hljs-keyword">return</span> promise;
	}

	finishRoute () {
		<span class="hljs-keyword">this</span>._loading = <span class="hljs-literal">false</span>;

		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'loadComplete'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>If other routes were queued while we were navigating, we’ll
start the next one right off.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.startRoute();
	}
}

<span class="hljs-built_in">module</span>.exports = Navigator;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
